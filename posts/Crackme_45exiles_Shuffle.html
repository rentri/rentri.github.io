<!DOCTYPE html>
<html lang="en">
   <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <link rel="stylesheet" href="/styles/blogs.css">
      <link href="https://fonts.googleapis.com/css2?family=DM+Sans&family=JetBrains+Mono&display=swap" rel="stylesheet">
      <title>Crackme: 45exile's Shuffle</title>
   </head>
   <body>
      <div class="main">
         <div class="blog">
            <a href="/">..</a>
            <article>
               <p class="post-meta"><time datetime="2025-07-11">05-08-2025</time></p>
               <!-- TITLE -->
               <h1>Crackme: 45exile's Shuffle</h1>
               <!-- Opening Paragaraph -->
               <p class="opening">
                  <!-- <sup id="fnref:1"><a href="#fn:1" style="text-decoration: none;"">[1]</a></sup> -->
                  Solving my first ever crackme <a href="https://crackmes.one/crackme/686f1b56aadb6eeafb399171">Shuffle</a> by <a href="https://crackmes.one/user/45exile">45exile</a>  
               </p>
               <div class="hr-div">
                  reconnaissance
               </div>
               <p class="hero">
                  After downloading the crackme I quickly ran it. 
               <pre>
❯ ./crackme
Enter the password please :
rentri
No... Maybe another time !
</pre>
               Lets run srtings on it.
               <pre>
❯ strings crackme
.
.
Gommage
Enter the password please :
Ygta_u3G_t0h_0aG_r3
Good Job !
No... Maybe another time !
.
.
</pre>
               These strings look interesting, we can clearly see some strings used in the password logic. <br> <br>
               However both <span>Gommage</span> and <span>Ygta_u3G_t0h_0aG_r3</span> are not the password. <br> <br>
               The next step is to open the binary in an online available decompiler explorer like <a href="https://dogbolt.org/">dogbolt</a>. <br>
               <br>
               Using the Hex-Rays decompiler I got the pseudo code and located the main function.
               <pre>
//----- (00000000000012E4) ----------------------------------------------------
__int64 __fastcall main(int a1, char **a2, char **a3)
{
  unsigned int v4; // [rsp+4h] [rbp-23Ch]
  int i; // [rsp+8h] [rbp-238h]
  int v6; // [rsp+Ch] [rbp-234h]
  char s[256]; // [rsp+20h] [rbp-220h] BYREF
  char dest[264]; // [rsp+120h] [rbp-120h] BYREF
  unsigned __int64 v9; // [rsp+228h] [rbp-18h]

  v9 = __readfsqword(0x28u);
  v4 = 0;
  puts("Enter the password please :");
  if ( !fgets(s, 256, stdin) )
    return 1;
  s[strcspn(s, "\r\n")] = 0;
  strncpy(dest, s, 0xFFu);
  dest[255] = 0;
  for ( i = 0; i < strlen("Gommage"); ++i )
    v4 = 31 * v4 + aGommage[i];
  v6 = strlen(dest);
  sub_1249((__int64)dest, v6, v4);
  if ( !strcmp("Ygta_u3G_t0h_0aG_r3", dest) )
    puts("Good Job !");
  else
    puts("No... Maybe another time !");
  return 0;
}
</pre>
               </p>
               <div class="hr-div">
                  analysing main
               </div>
               <p>
                  We can see the declaration of variable <span>s</span> of type <span>char</span> of size 256 characters or 2048 bits as 1 character = 1 byte = 8 bits.
                  Same with <span>dest</span>.
                  <br> <br>
                  <span>fgets(s, 256, stdin)</span> here <span>fgets</span> attempts to write 256 <span>char</span> to <span>s</span> from <span>stdin</span>. 
                  We can infer that <span>s</span> is user input.  <br>
                  More on <a href="https://en.cppreference.com/w/c/io/fgets">fgets</a>
                  <br> <br>
                  <span>s[strcspn(s, "\r\n")] = 0;</span> here <span>strcspn</span> gives the index of <span>\r\n</span><sup id="fnref:1"><a href="#fn:1" style="text-decoration: none;"">[1]</a></sup>
                  <br>
                  Thus we have <span>s[index] = '\0';</span> where <span>\0</span><sup id="fnref:2"><a href="#fn:2" style="text-decoration: none;"">[2]</a></sup> is a null terminator, we are setting the character at given index to a null terminator.
                  <br> <br>
                  <span>strncpy(dest, s, 0xFFu);</span> copies upto 255 characters from <span>s</span> to <span>dest</span>,
                  <br>
                  <span>0xFFu</span> is hexadecimal for 255 <br>
                  More on <a href="https://en.cppreference.com/w/c/string/byte/strncpy">strncpy</a>
                  <br> <br>
                  <span>dest[255] = 0;</span> is setting the last character in <span>dest</span> to a null terminator.
                  <br> <br>
                  Now comes the <span>for</span> loop. The loop starts from <span>i=0</span> and goes till <span>i=6</span> as length of "Gommage" is 7. <br>
                  The program had previously declared a varibale <span>v4</span> with value 0. Inside the loop <span>v4</span> will have the value of whatever 
                  <span>31 * v4 + aGommage[i];</span> gives when the loop finishes. <br>
                  <span>aGommage[i]</span> is quite confusing, it most probably is the ordinal value of characters in string "Gommage"
                  <br> <br>
                  Next we have <span>v6 = strlen(dest);</span>, which basically means that <span>v6</span> is an int having value equal to the length of <span>dest</span>
                  which is a cleaned user input.
                  <br> <br>
                  Just right below we can see a mysterious funtion <span>sub_1249</span> being called which is taking <span>(__int64)dest</span>, <span>v6</span>, <span>v4</span> as parameters.
                  <br>
                  <br> 
                  Lets first calculate the value of <span>v4</span> before exploring the mysterious function. <br>
                  The equivalent of the <span>for</span> loop in main in python would look like
               <pre>
v4 = 0
i = 0
ag = "Gommage"

for i in range(len(ag)):
    v4 = 31 * v4 + ord(ag[i])
</pre>
               which gives the final value of <span>v4</span> to be <span>66294604631</span> 
               <br> <br>
               We dont know what this value is being used for yet, for that we need to analyse the mysterious function.
               </p>
               <div class="hr-div">
                  analysing sub_1249
               </div>
               <p>
                  The <span>sub_1249</span> function is right above our main funtion in the decompiler. Lets take a look.
               <pre>
//----- (0000000000001249) ----------------------------------------------------
void __fastcall sub_1249(__int64 a1, int a2, unsigned int a3)
{
  int v3; // eax
  char v4; // [rsp+17h] [rbp-9h]
  int i; // [rsp+18h] [rbp-8h]

  if ( a1 && a2 > 0 )
  {
    srand(a3);
    for ( i = a2 - 1; i > 0; --i )
    {
      v3 = rand();
      v4 = *(_BYTE *)(i + a1);
      *(_BYTE *)(i + a1) = *(_BYTE *)(v3 % (i + 1) + a1);
      *(_BYTE *)(a1 + v3 % (i + 1)) = v4;
    }
  }
}
</pre>
               As we previously saw in <span>main</span>, the <span>sub_1249</span> function takes 3 parameters, <span>(__int64)dest</span>, <span>v6</span> and <span>v4</span>.
               <br> <br>
               From this we can infer that <span>a1</span> is <span>(__int64)dest</span>, <span>a2</span> is <span>v6</span> and <span>a3</span> is <span>v4</span>
               <br> <br>
               <span>(__int64)dest</span> is the a 64-bit pointer to a buffer. 
               <span>dest</span> now <span>a1</span> is being used as a pointer.
               <br> <br>
               <span>srand(a3)</span> is interesting. From this we finally know what the value of <span>v4</span> now <span>a3</span> is a seed for <span>rand()</span> <br>
               More on <a href="https://en.cppreference.com/w/cpp/numeric/random/srand.html">srand</a>
               <br> <br>
               The <span>for</span> loop is starting from the length of user input <span>a1</span>, and decrements till <span>i=1</span>.
               <br> <br>
               In the loop we first generate a random integer and assign its value to <span>v3</span>. 
               <br> <br>
               Now in <span>sub_1249</span>, <span>v4</span> is above decalred as of type <span>char</span> and it takes the value of 
               <span>*(_BYTE *)(i + a1);</span> which basically means <span>v4 = a1[i]</span>
               <br> <br>
               As <span>a1</span> is user input <span>v4 = *(_BYTE *)(i + a1);</span><sup id="fnref:3"><a href="#fn:3" style="text-decoration: none;"">[3]</a></sup> is equivalent to <span>v4 = a1[i]</span>
               <br> <br>
               The next line basically is <span>a1[i] = a1[v3 % (i+1)]</span>, here <span>v3</span> is a randmon number given by <span>rand()</span>.
               <br>
               The value of <span>v3 % (i+1)</span> is in range of <span>0<= v3 % (i+1) <= i</span>
               <br> <br>
               Next line basically is <span>a1[v3 % (i+1)]</span> which is equal to <span>v4</span>
               <br>
               This means that <span>a1[v3 % (i+1)] = v4</span>, which tells us that <span>v4</span> is just a temp placeholder to save value of <span>a1[i]</span> at the start.
               <br> <br>
               As we know, <span>a1</span> is being used as a pointer to a buffer, by the end of the <span>sub_1249</span> function, whatever value that buffer previously held would be mutated.
               <br>
               As in the above examples input is <span>dest</span> or <span>a1</span>, therefore the fucntion <span>sub_1249</span> mutates the value of user input.
               </p>
               <div class="hr-div">
                  back to main
               </div>
               <p> 
                  The final piece of the puzzle is 
               <pre>
if ( !strcmp("Ygta_u3G_t0h_0aG_r3", dest) )
    puts("Good Job !");
else
    puts("No... Maybe another time !");
return 0;
</pre>
               The function <span>strcmp</span> compares <span>Ygta_u3G_t0h_0aG_r3</span> with now mutated <span>dest</span>.
               <br> <br>
               So the password is such a string which when mutated by the funtion <span>sub_1249</span> turns into <span>Ygta_u3G_t0h_0aG_r3</span>
               </p>
               <div class="hr-div">
                  writing keygen
               </div>
               <p>
                  Its time to write the keygen, we have to reverse the mutation done by <span>sub_1249</span>
                  <br> <br>
                  We already have the script to generate the seed, but the issue is that the <span>rand</span> function is in C and will give different randomness compared to python.
                  <br> <br>
                  We need to look for a C equivalent in python<sup id="fnref:4"><a href="#fn:4" style="text-decoration: none;"">[4]</a></sup>
                  <br> <br>
                  Which is the <span>ctypes</span> module.
                  <br> <br>
                  Lets try to emulate the <span>sub_1249</span> function in python.
               <pre>
# mutator.py
from ctypes import CDLL
libc = CDLL("libc.so.6")

user_input = input("Enter the input: ").strip("\r\n")
len_user_input = len(user_input)

seed = 0
i = 0
ag = "Gommage"

for i in range(len(ag)):
    seed = 31 * seed + ord(ag[i])

libc.srand(seed)
user_input = (list(user_input))

for i in range(len_user_input-1, 0, -1):
    rand = libc.rand()
    temp = user_input[i]
    x = rand % (i+1)
    user_input[i] = user_input[x]
    user_input[x] = temp

output = ''.join(user_input)
print(output)
</pre>
               Running the mutator with input <span>rentri</span> gives 
               <pre>
 ❯ python3 mutator.py
Enter the input: rentri
rretin
</pre>
               So our keygen needs to be such that when we give input <span>rretin</span> we get output <span>rentri</span>
               <br> <br>
               One way to do that is to record each character swap in a set, this swap when done mutates the string so to unmutate the string we just 
               need to peform the swap in reverse.
               <pre>
# keygen.py
from ctypes import CDLL
libc = CDLL("libc.so.6")

user_input = input("Enter the input: ").strip("\r\n")
len_user_input = len(user_input)

seed = 0
i = 0
ag = "Gommage"

for i in range(len(ag)):
    seed = 31 * seed + ord(ag[i])

libc.srand(seed)
user_input = (list(user_input))

set_of_swaps = []

for i in range(len_user_input-1, 0, -1):
    rand = libc.rand()
    x = rand % (i+1)
    set_of_swaps.append((i, x))

for i, x in reversed(set_of_swaps):
    temp = user_input[i]
    user_input[i] = user_input[x]
    user_input[x] = temp

output = ''.join(user_input)
print(output)
</pre>
               When we give the keygen the input <span>rretin</span> we expect an output of <span>rentri</span>
               <pre>
 ❯ python3 keygen.py
Enter the input: rretin
rentri
</pre>
               We do indeed get the expected output <span>rentri</span>.
               <br> <br>
               </p>
               <div class="hr-div">
                  final solution
               </div>
               <P>
                  With this our keygen is done.
                  <br> <br>
                  Now to test it on <span>Ygta_u3G_t0h_0aG_r3</span>
               <pre>
 ❯ python3 keygen.py
Enter the input: Ygta_u3G_t0h_0aG_r3
GG_Y0u_ar3_th3_g0at
</pre>
               Lets test it
               <pre>
 ❯ ./crackme
Enter the password please :
GG_Y0u_ar3_th3_g0at
Good Job !
</pre>
               And its done the password is <span>GG_Y0u_ar3_th3_g0at</span>
               </p>
               <!-- FOOTNOTES -->
               <div class="hr-div">
                  footnotes
               </div>
               <div class="footnotes">
                  <p id="fn:1"> <a href="#fnref:1" style="text-decoration: none;">[1]</a> <a href="https://stackoverflow.com/questions/15433188/what-is-the-difference-between-r-n-r-and-n">StackOverflow: What is the difference between \r\n, \r, and \n?</a></p>
                  <p id="fn:2"> <a href="#fnref:2" style="text-decoration: none;">[2]</a> <a href="https://stackoverflow.com/questions/2037209/what-is-a-null-terminated-string">StackOverflow: What is a null-terminated string?</a></p>
                  <p id="fn:3"> <a href="#fnref:3" style="text-decoration: none;">[3]</a> <a href="https://stackoverflow.com/questions/45971632/reverse-engineering-ambiguous-syntax">StackOverflow: Reverse engineering ambiguous syntax</a></p>
                  <p id="fn:4"> <a href="#fnref:4" style="text-decoration: none;">[4]</a> <a href="https://stackoverflow.com/questions/60331996/does-python-have-a-function-to-mimic-the-sequence-of-cs-rand"">StackOverflow: Does Python have a function to mimic the sequence of C's rand()?</a></p>
               </div>
               <!-- COMMENTS -->
               <div class="hr-div">
                  comments
               </div>
               <script src="https://giscus.app/client.js"
                  data-repo="rentri/rentri.github.io"
                  data-repo-id="R_kgDOO_bTYw"
                  data-category="General"
                  data-category-id="DIC_kwDOO_bTY84Cs1Je"
                  data-mapping="pathname"
                  data-strict="1"
                  data-reactions-enabled="0"
                  data-emit-metadata="0"
                  data-input-position="top"
                  data-theme="noborder_dark" 
                  data-lang="en"
                  crossorigin="anonymous"
                  async></script>
            </article>
         </div>
      </div>
   </body>
</html>
